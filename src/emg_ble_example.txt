#include <Arduino.h>
#include <BLEDevice.h>
#include <BLEUtils.h>
#include <BLEServer.h>

// Custom 128-bit UUIDs for a service and two characteristics.
#define SERVICE_UUID          "c8c4a1d0-9f8a-4d4d-8d79-bd3e9e4c11b0"
#define EMG_RAW_CHAR_UUID     "6e2c1a30-4f27-4ad0-8c40-7aa3e1f8f5b4"
#define EMG_ENVELOPE_UUID     "c1f5bbda-f9cc-4a3e-a4c8-9f6247b70c4e"

// ADC pin wired to the EMG amplifier output; adjust for your ESP32-S3 board.
#define EMG_PIN 4

BLECharacteristic *emgRawChar = nullptr;
BLECharacteristic *emgEnvelopeChar = nullptr;

void setup() {
  Serial.begin(115200);
  Serial.println("Starting BLE EMG example");

  BLEDevice::init("ESP32S3-EMG");
  BLEServer *server = BLEDevice::createServer();
  BLEService *service = server->createService(SERVICE_UUID);

  emgRawChar = service->createCharacteristic(
      EMG_RAW_CHAR_UUID,
      BLECharacteristic::PROPERTY_READ | BLECharacteristic::PROPERTY_NOTIFY);

  emgEnvelopeChar = service->createCharacteristic(
      EMG_ENVELOPE_UUID,
      BLECharacteristic::PROPERTY_READ | BLECharacteristic::PROPERTY_NOTIFY);

  // Prime with zeros so a client can read immediately after connecting.
  uint8_t zeros[2] = {0, 0};
  emgRawChar->setValue(zeros, sizeof(zeros));
  emgEnvelopeChar->setValue(zeros, sizeof(zeros));

  // Configure ADC for EMG input (12-bit, 0-3.3 V typical with 11 dB attenuation).
  analogReadResolution(12);
  analogSetPinAttenuation(EMG_PIN, ADC_11db);

  service->start();

  BLEAdvertising *advertising = BLEDevice::getAdvertising();
  advertising->addServiceUUID(SERVICE_UUID);
  advertising->setScanResponse(true);
  advertising->setMinPreferred(0x06);
  advertising->setMinPreferred(0x12);
  BLEDevice::startAdvertising();
}

void loop() {
  static uint32_t lastSampleMs = 0;
  const uint32_t samplePeriodMs = 20;  // 50 Hz updates

  static float envelope = 0.0f;  // simple rectified + low-pass envelope
  const float alpha = 0.1f;       // smoothing factor (0-1); smaller = smoother

  uint32_t now = millis();
  if (now - lastSampleMs >= samplePeriodMs) {
    lastSampleMs = now;

    uint16_t emgRaw = analogRead(EMG_PIN);  // 0..4095 for 12-bit ADC

    // Update envelope: rectified value with single-pole low-pass.
    float rectified = static_cast<float>(emgRaw);
    envelope = (1.0f - alpha) * envelope + alpha * rectified;
    uint16_t envelopeU16 = static_cast<uint16_t>(envelope);

    // Send raw and envelope as little-endian 16-bit values.
    uint8_t rawPayload[2] = {static_cast<uint8_t>(emgRaw & 0xFF), static_cast<uint8_t>((emgRaw >> 8) & 0xFF)};
    uint8_t envPayload[2] = {static_cast<uint8_t>(envelopeU16 & 0xFF), static_cast<uint8_t>((envelopeU16 >> 8) & 0xFF)};

    emgRawChar->setValue(rawPayload, sizeof(rawPayload));
    emgEnvelopeChar->setValue(envPayload, sizeof(envPayload));

    emgRawChar->notify();
    emgEnvelopeChar->notify();
  }
}
